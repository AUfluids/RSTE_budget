/*---------------------------------------------------------------------------*\
License
    This file is part of RSTE_budget.

    RSTE_budget is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    RSTE_budget is distributed in the hope that it will be useful, but
    WITHOUT ANY WARRANTY; without even the implied warranty of MERCHANTABILITY
    or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU General Public License
    for more details.

    You should have received a copy of the GNU General Public License
    along with RSTE_budget. 
    If not, see <http://www.gnu.org/licenses/>.
/*---------------------------------------------------------------------------*\

FunctionObject
    Foam::calcPressureDiffusionTerm

Description
    Computes the pressure diffusion tensor term Dp_ij_RSTE from velocity-pressure gradient

Fields required
    - UMean            : Mean velocity field (volVectorField)
    - pMean            : Mean pressure field (volScalarField) 
    - UpMean           : Velocity-pressure correlation field (volVectorField)

Fields written
    - Dp_ij_RSTE       : Pressure diffusion tensor (volSymmTensorField)

Example usage in controlDict:
\verbatim
functions
{
    #include "calcRSTEcode/calcPressureDiffusionTerm"
}
\endverbatim

SourceFile
    calcPressureDiffusionTerm

Authors
    2025  Christoffer Hansen & Mario Javier Rincon

\*---------------------------------------------------------------------------*/

calcPressureDiffusionTerm
{
    name            calcPressureDiffusionTerm;
    type            coded;
    libs            ("libutilityFunctionObjects.so");
    enabled         true;
    log             true;
    timeStart       $startTimeFieldAverage;
    timeEnd         $endTime;
    executeControl  adjustableRunTime;
    executeInterval $writeInterval;
    writeControl    adjustableRunTime;
    writeInterval   $writeInterval;

    codeOptions     #{ -I$(LIB_SRC)/OpenFOAM/lnInclude -I$(LIB_SRC)/finiteVolume/lnInclude #};

    codeWrite
    #{
        #include "fvCFD.H"

        // Field names
        const word uMeanName  = "UMean";
        const word pMeanName  = "pMean";
        const word upMeanName = "UpMean";
        const word outputDpij  = "Dp_ij_RSTE";
       
        Info<< "Calculating Pressure Diffusion Term for FO: " << this->name() << " at t=" << mesh().time().timeName() << endl;

        // Lookup Optional <u'p'>

        const volVectorField& UMean = mesh().lookupObject<volVectorField>(uMeanName);
        const volScalarField& pMean = mesh().lookupObject<volScalarField>(pMeanName);
        const volVectorField& UpMean = mesh().lookupObject<volVectorField>(upMeanName);

        volVectorField UPrimePPrimeMean (IOobject("UPrimePPrimeMean", mesh().time().timeName(), mesh(), IOobject::NO_READ, IOobject::NO_WRITE),
                                         UpMean - (UMean * pMean));
        
        volTensorField gradUPrimePPrimeMean = fvc::grad(UPrimePPrimeMean); 
        
        volSymmTensorField Dp_ij_RSTE (IOobject(outputDpij, mesh().time().timeName(), mesh(), IOobject::NO_READ, IOobject::AUTO_WRITE),
                                       -2.0 * symm(gradUPrimePPrimeMean));
        
        Dp_ij_RSTE.correctBoundaryConditions();
        Dp_ij_RSTE.write();
            
        Info<< "  Written field: " << Dp_ij_RSTE.name() << endl;
        Info<< endl;
    #};
}